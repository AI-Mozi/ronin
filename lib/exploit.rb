require 'advisory'
require 'parameters'
require 'exceptions'
require 'socket'

module Ronin
  class Exploit

    # Vulnerability information
    attr_reader :advisory

    # Name of the specific vulnerability.
    attr_reader :name

    # Version of the vulnerability
    attr_reader :version

    # Exploit parameters
    attr_accessor :params

    # Exploit output
    attr_accessor :data

    # Restricted pattern that may not occurr in the exploit output
    attr_accessor :restricted

    def initialize(advisory=nil)
      @advisory = advisory
      @name = nil
      @version = nil
      @params = Parameters.new
      @data = nil
      @restricted = nil

      params['pad'] = Param.new('pad','text to use for padding',nil)

      params['lhost'] = Param.new('lhost','local host',nil)
      params['lport'] = Param.new('lhost','local port',nil)
      params['rhost'] = Param.new('rhost','remote host',nil)
      params['rport'] = Param.new('rhost','remote port',nil)
    end

    def build!
      if block_given?
	@data = ""
        yield self

	if @restricted && @restricted =~ @data
	  raise RestrictedText, "Restricted text was found in the exploit output", caller
	end
      end
    end

    def clean!
      if block_given?
        yield self
      end
      @data = nil
    end

    def get_pad
      padding = params['pad']
      unless padding
        padding = ENV['pad']
	unless padding
	  padding = 'A'
	end
      end
      return padding
    end

    def transmit_tcp
      rhost = param['rhost']
      unless rhost
        raise MissingParam, "missing 'remote host' parameter", caller
      end

      rport = param['rport']
      unless rport
        raise MissingParam, "missing 'remote port' parameter", caller
      end

      TCPSocket.new(rhost,rport) do
        yield if block_given?
      end
    end

    def transmit_udp
      rhost = param['rhost']
      unless rhost
        raise MissingParam, "missing 'remote host' parameter", caller
      end

      rport = param['rport']
      unless rport
        raise MissingParam, "missing 'remote port' parameter", caller
      end

      UDPSocket.new(rhost,rport) do |socket|
	lhost = param['lhost']
	lport = param['lport']
	socket.bind(lhost,lport) if lhost && lport

        yield if block_given?
      end
    end

    def transmit
      if @data && @data.length
        if block_given?
          yield self
        end
      end
    end

    def to_s
      @data
    end

  end
end
